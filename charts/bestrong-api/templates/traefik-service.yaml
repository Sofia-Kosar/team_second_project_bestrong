{{- if and .Values.ingress.enabled (not .Values.canary.enabled) (gt (.Values.canary.weight | int) 0) -}}
# This TraefikService is only created for the PROD release when canary.weight > 0
# It distributes traffic between prod and canary based on weights
apiVersion: traefik.io/v1alpha1
kind: TraefikService
metadata:
  name: bestrong-weighted
  namespace: default
  labels:
    app: bestrong
spec:
  weighted:
    services:
      # Stable/Production service gets majority of traffic
      - name: bestrong-prod
        namespace: default
        port: {{ .Values.service.port }}
        weight: {{ sub 100 .Values.canary.weight }}
      # Canary service gets the configured weight percentage
      - name: bestrong-canary
        namespace: default
        port: {{ .Values.service.port }}
        weight: {{ .Values.canary.weight }}
{{- end }}
